name: Release Charts

on:
  push:
    branches:
    - master
    tags:
    - '[0-9]+.[0-9]+.[0-9]+'
    - '[0-9]+.[0-9]+.[0-9]+-[a-z]+.[0-9]+'

env:
  CR_OWNER: sdmironov
  CR_GIT_REPO: helm
  CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    container: quay.io/helmpack/chart-releaser:v1.4.1
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # - name: Check that the git tag matches the chart version
    #   run: |
    #     CHART_VERSION=$(yq .version charts/Chart.yaml)
    #     if [[ "${GITHUB_REF_NAME}" == "${CHART_VERSION}" ]]; then
    #       echo "Git tag: ${GITHUB_REF_NAME}"
    #       echo "Chart version: ${CHART_VERSION}"
    #       echo "OK: Git tag matches chart version"
    #     else
    #       echo "Git tag: ${GITHUB_REF_NAME}"
    #       echo "Chart version: ${CHART_VERSION}"
    #       echo "ERROR: Git tag and chart version are different"
    #       exit 1
    #     fi

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        git config safe.directory '*'
    
    - name: test
      run: |
        cat .git/config
        ls -la
        whoami
        git status

    # - name: test inside
    #   uses: docker://quay.io/helmpack/chart-releaser:v1.4.1
    #   run: |
    #     cat .git/config
    #     ls -la
    #     whoami
    #     git status

    # - name: test inside
    #   uses: docker://quay.io/helmpack/chart-releaser:v1.4.1
    #   with:
    #     entrypoint: 'sh'
    #     args: -c "cat .git/config; ls -la; whoami; git status"
    #     options: --user 1001
    
    # - name: package
    #   uses: docker://quay.io/helmpack/chart-releaser:v1.4.1
    #   with:
    #     args: package charts/my-chart

    # - name: upload
    #   uses: docker://quay.io/helmpack/chart-releaser:v1.4.1
    #   with:
    #     args: upload charts/my-chart
    
    # - name: index
    #   uses: docker://quay.io/helmpack/chart-releaser:v1.4.1
    #   with:
    #     args: index charts/my-chart --push
